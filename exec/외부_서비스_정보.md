# 외부 서비스 정보

프로젝트에서 사용하는 외부 서비스 정보를 정리한 문서입니다.

---

## 1. Firebase Cloud Messaging (FCM)

### 용도
- 모바일 디바이스로 실시간 푸시 알림 전송
- 이상 행동 감지 시 사용자에게 즉각 알림

### 서비스 정보

| 항목              | 내용                                    |
|------------------|----------------------------------------|
| 서비스명         | Firebase Cloud Messaging               |
| 제공업체         | Google                                 |
| 프로젝트 ID      | heoby-7afdf                            |
| 사용 SDK         | Firebase Admin SDK for Java (9.3.0)   |
| 공식 문서        | https://firebase.google.com/docs/cloud-messaging |

### 설정 방법

#### 1. Firebase Console 설정
1. Firebase Console (https://console.firebase.google.com) 접속
2. 프로젝트 생성 또는 선택
3. 프로젝트 설정 → 서비스 계정 → 새 비공개 키 생성
4. JSON 파일 다운로드 → `heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json`

#### 2. Backend 설정
```java
// Spring Boot Configuration
// Firebase 초기화는 애플리케이션 시작 시 자동으로 수행됨

// FCM 메시지 전송 예시
FirebaseMessaging.getInstance().send(
    Message.builder()
        .setToken(deviceToken)
        .setNotification(Notification.builder()
            .setTitle("알림 제목")
            .setBody("알림 내용")
            .build())
        .build()
);
```

#### 3. Frontend (Web) 설정
```typescript
// Firebase Web SDK 초기화
import { initializeApp } from 'firebase/app';
import { getMessaging, getToken } from 'firebase/messaging';

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);
```

### 필요한 환경 변수

**Backend (.env.backend):**
```env
FIREBASE_CREDENTIALS_PATH=/app/heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json
```

**Frontend (.env.frontend):**
```env
VITE_FIREBASE_API_KEY=your_api_key_here
VITE_FIREBASE_AUTH_DOMAIN=heoby-7afdf.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=heoby-7afdf
VITE_FIREBASE_STORAGE_BUCKET=heoby-7afdf.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
VITE_FIREBASE_APP_ID=your_app_id
```

### 비용
- 무료 (Spark Plan) - 기본적인 FCM 사용은 무료
- 사용량 제한 없음

---

## 2. AWS S3 (Simple Storage Service)

### 용도
- 사용자 프로필 이미지 저장
- 이벤트 스냅샷 이미지 저장
- 영상 녹화 파일 저장 (선택사항)

### 서비스 정보

| 항목              | 내용                                    |
|------------------|----------------------------------------|
| 서비스명         | Amazon S3                              |
| 제공업체         | Amazon Web Services                    |
| 리전             | ap-northeast-2 (서울)                  |
| 버킷명           | heoby-bucket                           |
| 공식 문서        | https://docs.aws.amazon.com/s3         |

### 설정 방법

#### 1. AWS Console 설정
1. AWS Console (https://console.aws.amazon.com) 접속
2. S3 서비스로 이동
3. 버킷 생성: `heoby-bucket`
   - 리전: ap-northeast-2
   - 퍼블릭 액세스 차단 설정 (기본값 유지)
   - 버전 관리: 비활성화
4. IAM 사용자 생성 및 액세스 키 발급
   - 정책: AmazonS3FullAccess (또는 커스텀 정책)

#### 2. 버킷 폴더 구조
```
heoby-bucket/
├── profiles/           # 사용자 프로필 이미지
├── detections/         # 감지 이벤트 스냅샷
└── videos/             # 영상 녹화 파일 (선택)
```

#### 3. Backend 설정
```java
// Spring Boot에서 AWS S3 SDK 사용
// application.yml에서 설정 로드
@Value("${cloud.aws.s3.bucket}")
private String bucketName;

@Value("${cloud.aws.region.static}")
private String region;

// S3 파일 업로드 예시
s3Client.putObject(
    PutObjectRequest.builder()
        .bucket(bucketName)
        .key("profiles/" + filename)
        .build(),
    RequestBody.fromInputStream(inputStream, contentLength)
);
```

### 필요한 환경 변수

**Backend (.env.backend):**
```env
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key
AWS_S3_BUCKET=heoby-bucket
AWS_S3_REGION=ap-northeast-2
```

### CORS 설정

S3 버킷에 CORS 정책 설정 필요 (웹 브라우저에서 직접 업로드/다운로드 시):

```json
[
    {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
        "AllowedOrigins": ["http://k13e106.p.ssafy.io:3000", "http://localhost:3000"],
        "ExposeHeaders": ["ETag"]
    }
]
```

### 비용
- 스토리지: $0.025/GB (첫 50TB)
- PUT 요청: $0.005/1000 요청
- GET 요청: $0.0004/1000 요청
- 데이터 전송: $0.126/GB (아웃바운드)

---

## 3. MediaMTX (RTSP 미디어 서버)

### 용도
- 실시간 영상 스트리밍 (RTSP 프로토콜)
- 카메라 → 서버 → 클라이언트 영상 중계

### 서비스 정보

| 항목              | 내용                                    |
|------------------|----------------------------------------|
| 서비스명         | MediaMTX                               |
| 제공업체         | BluenViron (오픈소스)                  |
| 버전             | latest                                 |
| 프로토콜         | RTSP, RTMP, HLS, WebRTC                |
| GitHub           | https://github.com/bluenviron/mediamtx |

### 설정 방법

#### 1. Docker로 실행
```bash
docker run -d \
  --name heoby-mediamtx \
  -p 8554:8554 \
  -p 8888-8889:8888-8889 \
  -v $(pwd)/mediamtx.yml:/mediamtx.yml \
  bluenviron/mediamtx:latest
```

#### 2. 설정 파일 (mediamtx.yml)
```yaml
# RTSP 설정
rtspAddress: :8554
protocols: [tcp, udp]

# HLS 설정 (웹 브라우저 지원)
hlsAddress: :8888

# 인증 설정 (선택)
# authentication:
#   method: basic
#   users:
#     - username: user
#       password: pass

# 스트림 경로 설정
paths:
  stream:
    source: publisher
    publishUser: admin
    publishPass: admin123
```

#### 3. 스트림 송출
```bash
# FFmpeg를 사용한 테스트 스트림 송출
ffmpeg -re -i test.mp4 -c copy -f rtsp rtsp://k13e106.p.ssafy.io:8554/stream
```

#### 4. 스트림 수신
```javascript
// Frontend에서 HLS 플레이어 사용
<video>
  <source src="http://k13e106.p.ssafy.io:8888/stream/index.m3u8" type="application/x-mpegURL">
</video>
```

### 필요한 환경 변수

**Frontend (.env.frontend):**
```env
VITE_RTSP_URL=rtsp://k13e106.p.ssafy.io:8554/stream
VITE_HLS_URL=http://k13e106.p.ssafy.io:8888/stream/index.m3u8
```

### 비용
- 무료 (오픈소스)

---

## 4. Eclipse Mosquitto (MQTT 브로커)

### 용도
- ML 추론 서버 → Backend 이벤트 전송
- 실시간 메시지 브로커

### 서비스 정보

| 항목              | 내용                                    |
|------------------|----------------------------------------|
| 서비스명         | Eclipse Mosquitto                      |
| 제공업체         | Eclipse Foundation (오픈소스)          |
| 버전             | 2.x                                    |
| 프로토콜         | MQTT v3.1.1, v5.0                      |
| 공식 사이트      | https://mosquitto.org                  |

### 설정 방법

#### 1. Docker로 실행
```bash
docker run -d \
  --name heoby-mqtt \
  -p 1883:1883 \
  -p 8883:8883 \
  eclipse-mosquitto:latest
```

#### 2. 토픽 구조
```
heoby/
├── detection/events        # 객체 감지 이벤트
├── detection/alerts        # 이상 행동 알림
├── pose/estimation         # 포즈 추정 결과
└── system/status           # 시스템 상태
```

#### 3. Backend에서 구독
```java
@MqttSubscribe("heoby/detection/events")
public void handleDetectionEvent(String payload) {
    // 이벤트 처리 로직
}
```

#### 4. ML Server에서 발행
```python
import paho.mqtt.client as mqtt

client = mqtt.Client()
client.connect("k13e106.p.ssafy.io", 1883)
client.publish("heoby/detection/events", json.dumps(event_data))
```

### 필요한 환경 변수

**Backend (.env.backend):**
```env
MQTT_BROKER_URL=tcp://k13e106.p.ssafy.io:1883
MQTT_CLIENT_ID=heoby-backend
MQTT_USERNAME=
MQTT_PASSWORD=
```

**ML Server (.env):**
```env
MQTT_BROKER=k13e106.p.ssafy.io
MQTT_PORT=1883
MQTT_TOPIC=heoby/detection
```

### 비용
- 무료 (오픈소스)

---

## 5. 기타 참고사항

### 5.1 환경별 서비스 엔드포인트

**Production:**
```
Frontend:    http://k13e106.p.ssafy.io:3000
Backend API: http://k13e106.p.ssafy.io:8081/api
RTSP Stream: rtsp://k13e106.p.ssafy.io:8554/stream
HLS Stream:  http://k13e106.p.ssafy.io:8888/stream/index.m3u8
MQTT:        tcp://k13e106.p.ssafy.io:1883
ML Server:   http://k13e106.p.ssafy.io:8000
```

**Development:**
```
Frontend:    http://k13e106.p.ssafy.io:3100
Backend API: http://k13e106.p.ssafy.io:8181/api
RTSP Stream: rtsp://k13e106.p.ssafy.io:8554/stream
ML Server:   http://localhost:8000
```

### 5.2 보안 주의사항

1. **API 키 및 비밀번호**
   - `.env` 파일은 절대 Git에 커밋하지 않습니다
   - `.gitignore`에 반드시 포함시킵니다
   - 프로덕션 키는 Jenkins Secret File로 관리합니다

2. **Firebase Admin SDK**
   - JSON 파일은 서버에만 보관
   - 절대 클라이언트 코드에 포함하지 않습니다

3. **AWS Access Key**
   - IAM 사용자는 최소 권한만 부여
   - 정기적으로 키 로테이션

4. **MQTT 브로커**
   - 프로덕션 환경에서는 인증 활성화 권장
   - TLS/SSL 적용 권장

### 5.3 모니터링 및 로깅

외부 서비스 사용 시 다음 사항을 모니터링합니다:

- FCM: 발송 성공률, 실패 원인
- S3: 스토리지 사용량, 요청 횟수
- MQTT: 연결 상태, 메시지 전송량
- MediaMTX: 스트림 연결 수, 대역폭 사용량

---

## 6. 문의

외부 서비스 연동 관련 문제는 GitLab Issue를 통해 문의해주세요.
