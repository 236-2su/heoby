# 빌드 및 배포 가이드

GitLab 소스 클론 이후 빌드 및 배포할 수 있도록 정리한 문서입니다.

## 1. 사용 기술 및 버전 정보

### 1.1 JVM 및 개발 환경

| 구분        | 제품/기술                | 버전              |
|-------------|-------------------------|-------------------|
| JDK         | OpenJDK                 | 17                |
| IDE         | IntelliJ IDEA           | 2023.3 이상       |
| IDE         | VSCode                  | 최신 버전         |
| Build Tool  | Gradle                  | 8.10.2 (Wrapper)  |
| Node.js     | Node.js                 | v20.x 이상        |
| Python      | Python                  | 3.10 ~ 3.11       |

### 1.2 서버 및 WAS

| 구분           | 제품/기술           | 버전              |
|----------------|-------------------|-------------------|
| Web Server     | Nginx             | 1.18 이상         |
| WAS            | Spring Boot 내장  | Tomcat 10.x       |
| Application    | Spring Boot       | 3.3.4             |
| Database       | MySQL             | 8.0.x             |
| Cache          | Redis             | 7.x               |

### 1.3 배포 환경

| 구분              | 제품/기술                  | 버전/설정              |
|-------------------|---------------------------|----------------------|
| 컨테이너          | Docker                    | 24.x 이상            |
| 오케스트레이션    | Docker Compose            | v2.x 이상            |
| CI/CD             | Jenkins                   | LTS (JDK 17)         |
| OS                | Ubuntu                    | 22.04 LTS            |
| 배포 서버         | k13e106.p.ssafy.io        | -                    |

### 1.4 미디어 및 메시징

| 구분              | 제품/기술          | 버전              |
|-------------------|--------------------|-------------------|
| RTSP 서버         | MediaMTX           | latest            |
| MQTT 브로커       | Eclipse Mosquitto  | 2.x               |
| 푸시 알림         | Firebase FCM       | Admin SDK 9.3.0   |

### 1.5 ML/AI

| 구분              | 제품/기술          | 버전              |
|-------------------|--------------------|-------------------|
| 프레임워크        | FastAPI            | 0.111.x           |
| ASGI 서버         | Uvicorn            | 0.30.x            |
| 객체 감지         | Ultralytics YOLO   | 8.2.x             |
| 포즈 추정         | MediaPipe          | 0.10.14           |
| 영상 처리         | OpenCV             | 4.9.x             |
| 머신러닝          | scikit-learn       | 1.4.x             |

---

## 2. 빌드 환경 변수

### 2.1 Backend 환경 변수

Backend 빌드 및 실행 시 필요한 환경 변수는 `config/{환경}/.env.backend` 파일에 정의합니다.

**필수 환경 변수:**

```env
# Spring Profile
SPRING_PROFILES_ACTIVE=prod  # 또는 dev

# Database
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/heoby?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
SPRING_DATASOURCE_USERNAME=heoby_user
SPRING_DATASOURCE_PASSWORD=your_password_here

# Redis
SPRING_DATA_REDIS_HOST=localhost
SPRING_DATA_REDIS_PORT=6379
SPRING_DATA_REDIS_PASSWORD=

# JWT
JWT_SECRET=your_jwt_secret_key_at_least_256_bits_long
JWT_ACCESS_TOKEN_EXPIRATION=3600000  # 1시간 (ms)
JWT_REFRESH_TOKEN_EXPIRATION=604800000  # 7일 (ms)

# AWS S3
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_S3_BUCKET=heoby-bucket
AWS_S3_REGION=ap-northeast-2

# MQTT
MQTT_BROKER_URL=tcp://localhost:1883
MQTT_CLIENT_ID=heoby-backend
MQTT_USERNAME=
MQTT_PASSWORD=

# Firebase FCM
FIREBASE_CREDENTIALS_PATH=/app/heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json

# Server
SERVER_PORT=8080
```

### 2.2 Frontend 환경 변수

Frontend 빌드 시 필요한 환경 변수는 `config/{환경}/.env.frontend` 파일에 정의합니다.

**필수 환경 변수:**

```env
# API
VITE_API_BASE_URL=http://k13e106.p.ssafy.io:8081/api
VITE_WS_URL=ws://k13e106.p.ssafy.io:8081/ws

# Firebase
VITE_FIREBASE_API_KEY=your_firebase_api_key
VITE_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your_project_id
VITE_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
VITE_FIREBASE_APP_ID=your_app_id

# RTSP Stream
VITE_RTSP_URL=rtsp://k13e106.p.ssafy.io:8554/stream
```

### 2.3 ML Inference Server 환경 변수

ML 서버 실행 시 필요한 환경 변수는 `ml_inference/.env` 파일에 정의합니다.

```env
# FastAPI
FASTAPI_HOST=0.0.0.0
FASTAPI_PORT=8000
FASTAPI_WORKERS=1

# MQTT
MQTT_BROKER=k13e106.p.ssafy.io
MQTT_PORT=1883
MQTT_TOPIC=heoby/detection

# Backend API
BACKEND_API_URL=http://k13e106.p.ssafy.io:8081/api

# Model Settings
YOLO_MODEL_PATH=/app/models/best.pt
POSE_MODEL_PATH=/app/models/svm_model_sit_stand_lie.pkl
CONFIDENCE_THRESHOLD=0.5
```

---

## 3. 빌드 방법

### 3.1 Backend 빌드

```bash
cd BE/heoby

# 1. 의존성 다운로드 및 테스트 없이 빌드
./gradlew clean build -x test

# 2. 빌드 산출물 확인
ls -la build/libs/
# heoby-0.0.1-SNAPSHOT.jar 파일 생성 확인

# 3. Docker 이미지 빌드 (선택사항)
cd ../../deploy
docker compose -f docker-compose.yml -f docker-compose.prod.yml build backend
```

**빌드 산출물 위치:** `BE/heoby/build/libs/heoby-0.0.1-SNAPSHOT.jar`

### 3.2 Frontend 빌드

```bash
cd FE/heoby_web

# 1. 의존성 설치
npm ci  # 또는 npm install

# 2. 빌드
npm run build

# 3. 빌드 산출물 확인
ls -la dist/
# index.html, assets/ 등 정적 파일 생성 확인

# 4. Docker 이미지 빌드 (선택사항)
cd ../../deploy
docker compose -f docker-compose.yml -f docker-compose.prod.yml build frontend
```

**빌드 산출물 위치:** `FE/heoby_web/dist/`

### 3.3 ML Inference Server 설정

```bash
cd ml_inference

# 1. Python 가상환경 생성
python3 -m venv venv

# 2. 가상환경 활성화
source venv/bin/activate  # Linux/Mac
# Windows: venv\Scripts\activate

# 3. 의존성 설치
pip install -r requirements.txt

# 4. 모델 파일 확인
ls -la models/
# best.pt, svm_model_sit_stand_lie.pkl 파일 존재 확인
```

---

## 4. 배포 방법

### 4.1 환경 설정 파일 준비

배포 전 반드시 환경별 설정 파일을 준비해야 합니다:

```bash
# 디렉토리 구조
config/
├── dev/
│   ├── .env.backend
│   ├── .env.frontend
│   └── heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json
└── prod/
    ├── .env.backend
    ├── .env.frontend
    └── heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json
```

샘플 파일은 `config/.env.*.sample` 참고

### 4.2 Docker Compose로 배포

**Production 환경:**

```bash
cd deploy

# 1. 환경 변수 설정
export ENV_STAGE=prod

# 2. Docker Compose 실행
docker compose --project-name heoby-prod \
  -f docker-compose.yml \
  -f docker-compose.prod.yml \
  up -d

# 3. 서비스 상태 확인
docker compose --project-name heoby-prod ps

# 4. 로그 확인
docker compose --project-name heoby-prod logs -f backend
docker compose --project-name heoby-prod logs -f frontend
```

**Development 환경:**

```bash
cd deploy

# 1. 환경 변수 설정
export ENV_STAGE=dev

# 2. Docker Compose 실행
docker compose --project-name heoby-dev \
  -f docker-compose.yml \
  -f docker-compose.dev.yml \
  up -d

# 3. 서비스 상태 확인
docker compose --project-name heoby-dev ps
```

### 4.3 개별 서비스 배포

**Backend 단독 배포:**

```bash
# 1. JAR 파일 실행
cd BE/heoby
java -jar \
  -Dspring.profiles.active=prod \
  -Dserver.port=8080 \
  build/libs/heoby-0.0.1-SNAPSHOT.jar

# 또는 Docker로 실행
docker run -d \
  --name heoby-backend \
  --env-file config/prod/.env.backend \
  -p 8081:8080 \
  -v $(pwd)/config/prod:/config \
  heoby-prod-backend:latest
```

**Frontend 단독 배포:**

```bash
# Nginx로 dist 폴더 서빙
docker run -d \
  --name heoby-frontend \
  -p 3000:80 \
  -v $(pwd)/FE/heoby_web/dist:/usr/share/nginx/html:ro \
  nginx:alpine
```

**ML Inference Server 배포:**

```bash
cd ml_inference

# 가상환경에서 실행
source venv/bin/activate
uvicorn fastapi_app.main:app --host 0.0.0.0 --port 8000

# 또는 백그라운드 실행
nohup uvicorn fastapi_app.main:app --host 0.0.0.0 --port 8000 > ml_server.log 2>&1 &
```

---

## 5. 배포 시 특이사항

### 5.1 포트 설정

| 서비스               | 포트 (Dev)  | 포트 (Prod) |
|---------------------|-------------|-------------|
| Backend             | 8181        | 8081        |
| Frontend            | 3100        | 3000        |
| Redis               | 6380        | 6379        |
| MySQL               | 3307        | 3306        |
| MediaMTX (RTSP)     | 8554        | 8554        |
| MQTT                | 1883        | 1883        |
| ML Inference Server | 8000        | 8000        |

### 5.2 Nginx 설정

Nginx는 시스템 서비스로 실행되며, 다음 역할을 수행합니다:
- Frontend 정적 파일 서빙
- Backend API 리버스 프록시
- SSL 종단 (프로덕션 환경)

Nginx 설정 파일은 서버의 `/etc/nginx/sites-available/default`에 위치합니다.

### 5.3 Database 초기화

**최초 배포 시 DB 스키마 생성:**

```bash
# 1. MySQL 접속
mysql -u root -p

# 2. 데이터베이스 생성
CREATE DATABASE heoby CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 3. 사용자 생성 및 권한 부여
CREATE USER 'heoby_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON heoby.* TO 'heoby_user'@'%';
FLUSH PRIVILEGES;

# 4. DB 덤프 파일 import (선택사항)
mysql -u heoby_user -p heoby < exec/db_dump/heoby_dump_latest.sql
```

**JPA Auto DDL 설정:**

개발 환경에서는 `spring.jpa.hibernate.ddl-auto=update` 설정으로 자동 스키마 업데이트를 사용할 수 있습니다.
프로덕션 환경에서는 반드시 `validate`로 설정하여 수동으로 마이그레이션을 관리합니다.

### 5.4 Firebase 설정

Firebase Admin SDK 인증 파일을 각 환경의 config 폴더에 배치해야 합니다:

```
config/
├── dev/
│   └── heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json
└── prod/
    └── heoby-7afdf-firebase-adminsdk-fbsvc-3c3337bafc.json
```

### 5.5 ML 모델 파일

ML 추론 서버 실행 전 모델 파일이 `ml_inference/models/` 디렉토리에 있어야 합니다:

```
ml_inference/models/
├── best.pt                          # YOLO v8 객체 감지 모델
└── svm_model_sit_stand_lie.pkl      # SVM 포즈 분류 모델
```

### 5.6 MQTT 및 MediaMTX 설정

**MQTT Broker (Mosquitto):**

```bash
# Docker로 실행
docker run -d \
  --name heoby-mqtt \
  -p 1883:1883 \
  -p 8883:8883 \
  eclipse-mosquitto:latest
```

**MediaMTX (RTSP Server):**

```bash
# Docker로 실행
docker run -d \
  --name heoby-mediamtx \
  -p 8554:8554 \
  -p 8888-8889:8888-8889 \
  -v $(pwd)/mediamtx.yml:/mediamtx.yml \
  bluenviron/mediamtx:latest
```

---

## 6. 주요 계정 및 프로퍼티 파일 목록

### 6.1 Backend 프로퍼티 파일

| 파일 경로                                        | 설명                        |
|------------------------------------------------|----------------------------|
| `BE/heoby/src/main/resources/application.yml`   | Spring Boot 기본 설정      |
| `BE/heoby/src/main/resources/application-dev.yml` | 개발 환경 설정           |
| `BE/heoby/src/main/resources/application-prod.yml` | 프로덕션 환경 설정       |
| `config/prod/.env.backend`                      | 프로덕션 환경 변수         |
| `config/dev/.env.backend`                       | 개발 환경 변수             |

### 6.2 Frontend 설정 파일

| 파일 경로                          | 설명                        |
|----------------------------------|----------------------------|
| `FE/heoby_web/.env.production`   | 프로덕션 빌드 환경 변수    |
| `FE/heoby_web/.env.development`  | 개발 빌드 환경 변수        |
| `config/prod/.env.frontend`      | 프로덕션 런타임 환경 변수  |
| `config/dev/.env.frontend`       | 개발 런타임 환경 변수      |

### 6.3 데이터베이스 계정

| 계정          | 호스트      | 데이터베이스 | 권한            |
|--------------|------------|-------------|-----------------|
| heoby_user   | localhost  | heoby       | ALL PRIVILEGES  |
| root         | localhost  | -           | SUPER USER      |

### 6.4 외부 서비스 계정 정보

자세한 내용은 `외부_서비스_정보.md` 참고

- AWS S3: Access Key, Secret Key
- Firebase: Admin SDK JSON 파일
- MQTT: Broker URL, Username, Password (선택)

---

## 7. 빌드 및 배포 체크리스트

### 빌드 전 체크리스트

- [ ] JDK 17 설치 확인
- [ ] Node.js v20+ 설치 확인
- [ ] Python 3.10-3.11 설치 확인
- [ ] Docker 및 Docker Compose 설치 확인
- [ ] 환경 변수 파일 준비 완료 (config/{env}/.env.*)
- [ ] Firebase Admin SDK JSON 파일 준비
- [ ] ML 모델 파일 준비 (models/*.pt, *.pkl)

### 배포 전 체크리스트

- [ ] MySQL 데이터베이스 생성 및 사용자 권한 설정
- [ ] Redis 서버 실행 확인
- [ ] MQTT 브로커 실행 확인
- [ ] MediaMTX RTSP 서버 실행 확인
- [ ] Nginx 설정 확인 및 서비스 재시작
- [ ] 방화벽 포트 오픈 확인
- [ ] SSL 인증서 설정 (프로덕션)
- [ ] DB 백업 완료

### 배포 후 확인사항

- [ ] 모든 Docker 컨테이너 정상 실행 확인
- [ ] Backend API Health Check 확인 (http://서버주소:8081/actuator/health)
- [ ] Frontend 접속 확인 (http://서버주소:3000)
- [ ] ML Inference Server Health Check 확인 (http://서버주소:8000/health)
- [ ] MQTT 연결 테스트
- [ ] RTSP 스트림 확인
- [ ] Firebase FCM 푸시 알림 테스트
- [ ] 로그 확인 (에러 없는지)

---

## 8. 트러블슈팅

### 8.1 Backend가 시작되지 않는 경우

```bash
# 1. 로그 확인
docker compose logs backend

# 2. 일반적인 원인
# - MySQL 연결 실패: DB 서버 실행 여부 및 접속 정보 확인
# - Redis 연결 실패: Redis 서버 실행 여부 확인
# - 포트 충돌: 8080/8081 포트 사용 여부 확인
# - 환경 변수 누락: .env.backend 파일 확인
```

### 8.2 Frontend 빌드 실패

```bash
# 1. Node 모듈 재설치
rm -rf node_modules package-lock.json
npm install

# 2. 캐시 클리어
npm cache clean --force

# 3. 환경 변수 확인
cat .env.production
```

### 8.3 ML Server가 모델을 로드하지 못하는 경우

```bash
# 1. 모델 파일 존재 확인
ls -la ml_inference/models/

# 2. 파일 권한 확인
chmod 644 ml_inference/models/*.pt
chmod 644 ml_inference/models/*.pkl

# 3. 경로 확인 (.env 파일의 YOLO_MODEL_PATH 등)
```

---

## 9. 문의

빌드 또는 배포 중 문제가 발생하면 GitLab Issue를 통해 문의해주세요.
